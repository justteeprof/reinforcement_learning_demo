<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RL Ventilator Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg,#eef2f3,#d9e2ec);
    margin:0;padding:0;color:#333;
}
.container {
    max-width:900px;
    margin:auto;
    padding:30px;
}
h1,h2{text-align:center;color:#4a2c1d;}
.card {
    background:white;
    border-radius:14px;
    padding:25px;
    margin-top:25px;
    box-shadow:0 12px 28px rgba(0,0,0,0.1);
}
.case{font-size:18px;line-height:1.7;margin-top:15px;}
button{
    padding:10px 15px;margin:5px;font-size:16px;border-radius:8px;border:none;background:#7a4a2e;color:white;cursor:pointer;
}
button:hover{background:#5d3722;}
.stats{margin-top:20px;font-size:16px;background:#f5f7f9;padding:15px;border-left:6px solid #7a4a2e;border-radius:8px;}
.hidden{display:none;}
</style>
</head>
<body>
<div class="container">
<h1>ü§ñ RL Ventilator Simulator</h1>
<h2>Can AI manage ventilator settings better than an average intensivist?</h2>

<div class="card" id="intro">
    <p class="case">
        The AI agent will adjust **ventilator settings** (tidal volume, PEEP, FiO‚ÇÇ) to maintain **simulated patient vitals** within safe ranges.  
        You can compare human benchmark adjustments with AI learning over episodes.
    </p>
    <button onclick="startGame()">Start Simulation</button>
</div>

<div class="card hidden" id="simCard">
    <h2 id="episodeTitle"></h2>

    <div class="case">
        <strong>Patient vitals:</strong>
        <div id="vitals"></div>
    </div>

    <div class="case">
        <strong>Adjust AI settings manually (optional):</strong><br>
        <button onclick="manualAdjust(-1)">Decrease Tidal Volume</button>
        <button onclick="manualAdjust(1)">Increase Tidal Volume</button>
        <button onclick="nextStep()">Next Step</button>
    </div>

    <div class="stats" id="stats">
        <strong>Episode:</strong> 0 | <strong>Reward:</strong> 0
    </div>
</div>

<div class="card hidden" id="resultsCard">
    <h2>üèÅ Simulation Complete</h2>
    <p class="case" id="finalStats"></p>
</div>
</div>

<script>
// -------------------- Simulated Patient Model --------------------
function generatePatientState() {
    // Simplified: vitals between 0-100 (ideal ~50)
    return {
        tidalVolume: Math.random() * 10 + 400, // ml
        PEEP: Math.random() * 5 + 5, // cmH2O
        FiO2: Math.random() * 0.2 + 0.4, // fraction
        oxygenation: Math.random() * 100, // SpO2 proxy
        compliance: Math.random() * 100 // lung compliance proxy
    };
}

function computeReward(state) {
    // Reward high if oxygenation is ~95, compliance ~50, penalize extremes
    let o2Score = -Math.abs(state.oxygenation-95);
    let compScore = -Math.abs(state.compliance-50);
    return o2Score + compScore; // higher is better
}

// -------------------- RL Agent --------------------
class RLAgent {
    constructor() {
        this.q = {}; // state-action table (simplified)
        this.learningRate = 0.1;
        this.gamma = 0.9;
    }

    chooseAction(state) {
        // Simple policy: randomly choose tidalVolume adjustment -1,0,1
        return [-1,0,1][Math.floor(Math.random()*3)];
    }

    update(state, action, reward, nextState) {
        // Simplified Q-learning update
        const key = `${state.tidalVolume.toFixed(0)}_${action}`;
        const nextKey = `${nextState.tidalVolume.toFixed(0)}_0`;
        const oldQ = this.q[key] || 0;
        const future = this.q[nextKey] || 0;
        this.q[key] = oldQ + this.learningRate * (reward + this.gamma * future - oldQ);
    }
}

// -------------------- Simulation --------------------
let patient, agent, episode, rewardTotal;

function startGame() {
    document.getElementById("intro").classList.add("hidden");
    document.getElementById("simCard").classList.remove("hidden");
    agent = new RLAgent();
    episode = 1;
    rewardTotal = 0;
    patient = generatePatientState();
    updateDisplay();
    document.getElementById("episodeTitle").innerText = `Episode ${episode}`;
}

function updateVitals() {
    // patient changes slightly
    patient.oxygenation += (Math.random()-0.5)*5;
    patient.compliance += (Math.random()-0.5)*5;
    patient.oxygenation = Math.max(60, Math.min(100, patient.oxygenation));
    patient.compliance = Math.max(20, Math.min(80, patient.compliance));
}

function updateDisplay() {
    document.getElementById("vitals").innerHTML = `
        Tidal Volume: ${patient.tidalVolume.toFixed(0)} ml<br>
        PEEP: ${patient.PEEP.toFixed(1)} cmH2O<br>
        FiO‚ÇÇ: ${(patient.FiO2*100).toFixed(0)} %<br>
        Oxygenation: ${patient.oxygenation.toFixed(0)}%<br>
        Compliance: ${patient.compliance.toFixed(0)}
    `;
    document.getElementById("stats").innerHTML = `
        <strong>Episode:</strong> ${episode} | <strong>Reward:</strong> ${rewardTotal.toFixed(1)}
    `;
}

// Manual control for demonstration
function manualAdjust(delta) {
    patient.tidalVolume += delta*20;
    patient.tidalVolume = Math.max(300, Math.min(700, patient.tidalVolume));
    nextStep();
}

// RL step
function nextStep() {
    const stateBefore = {...patient};
    const action = agent.chooseAction(stateBefore);
    patient.tidalVolume += action*10;
    patient.tidalVolume = Math.max(300, Math.min(700, patient.tidalVolume));
    updateVitals();
    const reward = computeReward(patient);
    rewardTotal += reward;
    agent.update(stateBefore, action, reward, patient);
    updateDisplay();
    episode++;
    document.getElementById("episodeTitle").innerText = `Episode ${episode}`;
    if(episode>15){
        endSimulation();
    }
}

function endSimulation() {
    document.getElementById("simCard").classList.add("hidden");
    document.getElementById("resultsCard").classList.remove("hidden");
    document.getElementById("finalStats").innerHTML = `
        AI finished learning!<br>
        Total Reward: ${rewardTotal.toFixed(1)}<br>
        Average Reward per Step: ${(rewardTotal/15).toFixed(2)}<br><br>
        Notice how the AI starts random, then gradually chooses adjustments to maintain vitals closer to ideal ranges.
    `;
}
</script>
</body>
</html>
